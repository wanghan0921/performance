> 进程线程的简单理解： 进程里面可以有多个线程，进程就是微信，线程就是会话

+ 浏览器是多进程的
+ 浏览器之所以能够运行，是因为系统给他的进程分配了资源（cpu、内存）
+ 简单点理解，每打开一个Tab页， 就相当于创建了一个独立的浏览器进程


## 浏览器里面的进程:

1. **Browser**进程：浏览器的主进程（负责协调、主控）只有一个。作用有： 

    + 负责浏览器界面的显示，与用户的交互，如前进、后退等
    + 负责各个页面的管理，创建和销毁其他进程
    + 将Renderer进程得到的内存中的Bitmap，绘制到用户界面上
    + 网络资源的管理，下载等
    
2. **第三方插件**进程： 每种类型的插件对应一个进程，仅当使用该插件时才创建

3. **GPU**进程： 最多一个，用于3D绘制等

4. **渲染**进程（浏览器内核）：Renderer进程，内部是多线程的

    + 默认一个tab页面一个进程，互不影响
    + 主要作用为页面渲染，脚本执行，时间处理等
    

## 渲染进程是多线程的：

1. GUI渲染进线程
  
    + 负责渲染浏览器界面，解析HTML、CSS，构建DOM树和RenderObject树，布局和绘制等
    + 当界面需要**重绘**或由于某种操作引发**回流**时，该线程就会执行
    + 注意，GUI线程和JS引擎线程是互斥的，当JS引擎线程执行时GUI线程会被挂起（相当于冻结了），GUI更新会被保存在一个队列中，等js引擎空闲时，会立即执行
    
2. JS引擎线程

    + 也称JS内核，负责处理JavaScript脚本程序（例如V8引擎）
    + JS引擎线程负责解析JavaScript脚本，运行代码
    + JS引擎一直等待任务队列中任务的到来，然后加以处理，一个Tab页（Renderer进程）中只有一个JS线程在运行
    + 同样注意，GUI渲染线程与Js引擎线程是互斥的，所以如果JS执行时间过长，要放在body下面，否则会导致页面渲染加载阻塞
    
3. 事件触发线程

    + 管理时间队列
    + 监听事件，符合条件时把回调函数放入事件队列中
    
4. 定时触发器线程

    + setInterval 与 setTimeout 在此线程中计时完毕，把回调函数放入事件队列中
    + 浏览器定时计数器并不是有JavaScript引擎计数的（因为JavaScript引擎是单线程的，如果处于阻塞线程状态就会影响计时的准确），因此通过单独线程来计时并触发定时（计时完毕后，添加到事件队列中，再由JavaScript引擎空闲后执行）
      
      > tips: 为什么setTimeout计时结束后，函数不会立即执行？ 因为计时是在 定时触发器线程 执行，结束后把函数添加到JS引擎线程中的事件队列中， 然后js是单线程，事件队列中前面可能有函数正在执行阻塞，所以有等待时间。
         并且前面如果没有函数阻塞，标准规定setTimeout中低于4ms的时间间隔算4ms
      
    + 注意，W3C在HTML标准中规定，规定要求setTimeout中低于4ms的时间间隔算4ms

5. 异步http请求线程

    + 检测到XHR对象状态变化时，将回调函数放入事件队列中
    + 将检测到状态变化时，如果设置有回调函数，异步线程就会产生状态变更事件，将这个回调函数再放入事件队列中，再由JavaScript引擎执行
    
    ![](https://github.com/wanghan0921/performance/blob/main/img/Snipaste_2020-11-07_17-10-51.png)




## 渲染线程和JS引擎线程互斥

由于JavaScript是可以操作DOM的，如果在修改这些元素属性同时渲染界面（即js线程和GUI线程同时运行），那么渲染线程前后获得的元素数据就可以不一样了

因此为了防止渲染出现不可预期的结果，浏览器设置GUI渲染线程和JS引擎线程为互斥关系，当JS引擎线程执行时，GUI渲染线程会被挂起，GUI更新则会被保存在一个队列中等到JS引起线程空闲时立即执行。

举一个简单的例子(字体颜色不会变成蓝色)：
```js
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        document.getElementById('app').style.color = 'blue'
    </script>
</head>
<body>
    <div id="app">hello</div>
</body>
</html>
```

## JS阻塞页面加载

从上述的互斥关系，可以推断出，js如果执行时间多长就会阻塞页面

例如，假设js引擎正在进行巨量的计算，此时就算GUI有更新，也会被保存到队列中，等JS引擎空闲后，然后，由于巨量计算，所以js引擎很可能很久以后才会空闲，那么用户自然会感觉到页面巨卡无比

所以，要尽量避免js执行时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞的感觉


## 总结

+ 浏览器是多进程的，一个tab页就是一个进程
+ 渲染进程是多线程的，主要是Renderer线程和js引擎线程
+ JavaScript阻塞Dom解析





























